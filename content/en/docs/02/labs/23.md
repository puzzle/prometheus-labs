---
title: "2.3 Tasks: Recording rules"
weight: 2
sectionnumber: 2
---

In this lab you are going to create your first own recording rules. [Recoding rules](https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/) are very useful when it comes to queries, which are very complex and take a long time to calculate.

{{% alert title="Warning" color="secondary" %}}
Recording rules store the result in a new series and they can add additional complexity.
{{% /alert %}}

### Task {{% param sectionnumber %}}.1: Memory Sum Recording Rule

Add the following recording rule in a file named `recording_rules.yml` and include it in the Prometheus config

```yaml
groups:
  - name: node_memory
    rules:
      - record: :node_memory_MemAvailable_bytes:sum
        expr: |
          1 - (
            sum by(instance) (node_memory_MemFree_bytes + node_memory_Cached_bytes + node_memory_Buffers_bytes)
          )
          /
            sum by(instance) (node_memory_MemTotal_bytes)
```
In this recording rule we create a new metric, which represents the available memory on a node. A metric the `node exporter` doesn't expose and needs to be calculated every time, you need it.


{{% details title="Hints" mode-switcher="normalexpertmode" %}}

Create the recording rule file next to the `prometheus.yml` under `~/work/FIXME/recording_rules.yml` with the following command:

```bash
cat <<EOF > recording_rules.yml
groups:
  - name: node_memory
    rules:
      - record: :node_memory_MemAvailable_bytes:sum
        expr: |
          1 - (
            sum by(instance) (node_memory_MemFree_bytes + node_memory_Cached_bytes + node_memory_Buffers_bytes)
          )
          /
            sum by(instance) (node_memory_MemTotal_bytes)
EOF
```

We also need to tell Prometheus to consider the new `recording_rules.yml` file, by altering the `prometheus.yml`

```yaml
rule_files:
  - "recording_rules.yml"
```

The last thing we need to do is to reload Prometheus
```bash
killall -HUP prometheus
```
{{% /details %}}

After configuring the recording rule and reloading the configuration, Prometheus now provides those metrics accordingly.

**Task description**: Query the recording rule in the Prometheus web UI

{{% details title="Hints" mode-switcher="normalexpertmode" %}}

Use your `recording_rule` definition in the expression browser:

```promql
node_memory_MemAvailable_bytes:sum
```

or hit the following link:
<http://LOCALHOST:9090/graph?g0.range_input=1h&g0.expr=%3Anode_memory_MemAvailable_bytes%3Asum>

{{% /details %}}

### Task {{% param sectionnumber %}}.2: CPU utilisation Recording Rule

In this lab you are going to create an other recording rule

**Task description**:

* Create a rule to record the **CPU usage** of your VM
* Make sure that Prometheus evaluates this rule every **10 seconds**
* Verify in the Prometheus web UI that you can query your recording rule

{{% details title="Hints" mode-switcher="normalexpertmode" %}}

As you've seen in the previous lab the metric `node_cpu_seconds_total` contains CPU usage of a node. We can use `mode` label on this metrics to filter for `idle` cpu time.

All other modes than `idle` mean, the CPU is used. In conclusion we therefore can simply subtract the idle percentage from 100 % ang get the value we want in this case.

Add the recording rule to `recording_rules.yml`:
```yaml
...
  - name: node_cpu
    interval: 10s
    rules:
      - record: instance:node_cpu_utilisation:rate5m
        expr: |
          100 - (
            avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m]))
            * 100
          )
```
by specifying the `interval`, you can overwrite the default evaluation interval.

Reload Prometheus
```bash
killall -HUP prometheus
```

Use your `recording_rule` definition in the expression browser: <http://LOCALHOST:9090/graph?g0.expr=instance%3Anode_cpu_utilisation%3Arate5m>
{{% /details %}}
